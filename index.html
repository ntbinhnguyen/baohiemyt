<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu√©t QR Code (jsQR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Th∆∞ vi·ªán jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #000;
      color: white;
    }
    #video {
      flex: 1;
      width: 100%;
      object-fit: cover;
    }
    #controls {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      background: #111;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    #toggleBtn {
      background: #007bff;
      color: white;
    }
    #captureBtn {
      background: #28a745;
      color: white;
    }
    #result {
      padding: 10px;
      text-align: center;
      font-size: 18px;
      background: #111;
    }
  </style>
</head>
<body>
  <video id="video" playsinline autoplay></video>
  <canvas id="canvas" hidden></canvas>

  <div id="controls">
    <button id="toggleBtn">üî¥ T·∫Øt camera</button>
    <button id="captureBtn">üì∑ Ch·ª•p ·∫£nh</button>
  </div>

  <div id="result">üëâ H∆∞·ªõng camera v√†o QR Code</div>

  <script>
    const video = document.getElementById("video");
    const canvasElement = document.getElementById("canvas");
    const canvas = canvasElement.getContext("2d");
    const result = document.getElementById("result");
    const toggleBtn = document.getElementById("toggleBtn");
    const captureBtn = document.getElementById("captureBtn");

    let stream = null;
    let scanning = false;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        });
      } catch (err) {
        // fallback n·∫øu exact kh√¥ng h·ªó tr·ª£
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });
      }

      video.srcObject = stream;
      video.setAttribute("playsinline", true); // cho iOS Safari
      video.play();
      scanning = true;
      requestAnimationFrame(tick);
      toggleBtn.textContent = "üî¥ T·∫Øt camera";
    }

    async function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      scanning = false;
      toggleBtn.textContent = "üü¢ B·∫≠t camera";
      result.textContent = "üì¥ Camera ƒë√£ t·∫Øt";
    }

    function tick() {
      if (scanning && video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.width = video.videoWidth;
        canvasElement.height = video.videoHeight;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert"
        });

        if (code) {
          result.textContent = "‚úÖ QR Code: " + code.data;
        }
      }
      if (scanning) requestAnimationFrame(tick);
    }

    toggleBtn.addEventListener("click", () => {
      if (scanning) {
        stopCamera();
      } else {
        startCamera();
      }
    });

    captureBtn.addEventListener("click", () => {
      if (!scanning) {
        alert("‚ùå Camera ch∆∞a b·∫≠t!");
        return;
      }
      const link = document.createElement("a");
      link.download = "qr_capture.png";
      link.href = canvasElement.toDataURL("image/png");
      link.click();
    });

    // T·ª± b·∫≠t camera khi load
    startCamera();
  </script>
</body>
</html>
